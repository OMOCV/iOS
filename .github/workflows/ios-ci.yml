name: iOS CI

on:
  push:
    branches: [ main, develop ]

  pull_request:
    branches: [ main, develop ]

  workflow_dispatch:
    inputs:
      build-ipa:
        type: boolean
        description: "ÊòØÂê¶ÊûÑÂª∫ IPAÔºü"
        required: false
        default: true


jobs:
  # -------------------------
  # Job 1: Build & Test (Simulator)
  # -------------------------
  build:
    name: Build & Test (Simulator)
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: "16.0"

    - name: Simulator build
      run: |
        xcodebuild clean build \
          -project ABBRobotReader.xcodeproj \
          -scheme ABBRobotReader \
          -sdk iphonesimulator \
          -destination "generic/platform=iOS Simulator" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO


  # -------------------------
  # Job 2: Build IPA (Device)
  # -------------------------
  build-ipa:
    name: Build IPA
    runs-on: macos-latest
    needs: build
    env:
      APP_BUNDLE_ID: com.omocv.ABBRobotReader

    if: >
      github.event_name == 'push' && github.ref == 'refs/heads/main'
      || github.event_name == 'workflow_dispatch' && github.event.inputs.build-ipa == 'true'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: "16.0"

    # -------------------------
    # ÂØºÂÖ•ËØÅ‰π¶
    # -------------------------
    - name: Import Signing Certificate
      uses: apple-actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.IOS_P12 }}
        p12-password: ${{ secrets.IOS_P12_PASSWORD }}
        keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}

    # -------------------------
    # ÂÆâË£ÖÊèèËø∞Êñá‰ª∂
    # -------------------------
    - name: Install Provisioning Profile
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
        echo "${{ secrets.IOS_MOBILEPROVISION }}" | base64 --decode > "$PROFILE_PATH"

        echo "Ëß£ÊûêÊèèËø∞Êñá‰ª∂..."
        security cms -D -i "$PROFILE_PATH" > profile.plist

        PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' profile.plist)
        PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' profile.plist)
        TEAM_ID=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' profile.plist)

        echo "PROVISIONING_PROFILE_SPECIFIER=$PROFILE_NAME" >> $GITHUB_ENV
        echo "PROVISIONING_PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
        echo "DEVELOPMENT_TEAM=$TEAM_ID" >> $GITHUB_ENV

        echo "üìå ‰ΩøÁî®ÊèèËø∞Êñá‰ª∂Ôºö$PROFILE_NAME"
        echo "üìå UUID: $PROFILE_UUID"
        echo "üìå TeamID: $TEAM_ID"

    # -------------------------
    # ÁîüÊàê ExportOptions.plist
    # -------------------------
    - name: Generate ExportOptions.plist
      run: |
        cat > ExportOptions.plist <<'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
"http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>method</key>
  <string>ad-hoc</string>

  <key>teamID</key>
  <string>${{ env.DEVELOPMENT_TEAM }}</string>

  <key>signingStyle</key>
  <string>manual</string>

  <key>provisioningProfiles</key>
  <dict>
    <key>${{ env.APP_BUNDLE_ID }}</key>
    <string>${{ env.PROVISIONING_PROFILE_SPECIFIER }}</string>
  </dict>

  <key>stripSwiftSymbols</key>
  <true/>

  <key>compileBitcode</key>
  <false/>
</dict>
</plist>
EOF

    # -------------------------
    # ÁîüÊàê Archive
    # -------------------------
    - name: Archive
      run: |
        xcodebuild archive \
          -project ABBRobotReader.xcodeproj \
          -scheme ABBRobotReader \
          -archivePath build/ABBRobotReader.xcarchive \
          -configuration Release \
          -destination "generic/platform=iOS" \
          CODE_SIGN_STYLE=Manual \
          DEVELOPMENT_TEAM=${{ env.DEVELOPMENT_TEAM }} \
          PROVISIONING_PROFILE_SPECIFIER=${{ env.PROVISIONING_PROFILE_SPECIFIER }}

        echo "Archive ÂÜÖÂÆπÔºö"
        ls -R build/ABBRobotReader.xcarchive

    # -------------------------
    # ÂØºÂá∫ IPA
    # -------------------------
    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath build/ABBRobotReader.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath build/IPA_Output

        echo "ÂØºÂá∫ÂÆåÊàêÔºö"
        ls -lh build/IPA_Output

    # -------------------------
    # ‰∏ä‰º† IPA
    # -------------------------
    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ABBRobotReader-IPA-${{ github.sha }}
        path: build/IPA_Output/*.ipa
        retention-days: 30
        if-no-files-found: error

    # -------------------------
    # ‰∏ä‰º† Archive
    # -------------------------
    - name: Upload Archive
      uses: actions/upload-artifact@v4
      with:
        name: ABBRobotReader-Archive-${{ github.sha }}
        path: build/ABBRobotReader.xcarchive
        retention-days: 7
        if-no-files-found: error